name: Weekly Changelog

on:
  schedule:
    # 毎週水曜日 01:00 UTC (10:00 JST)
    - cron: "0 1 * * 3"
  workflow_dispatch:
    inputs:
      end_date:
        description: "終了日 (YYYY-MM-DD形式、空欄で今日)"
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  # Phase 1: データ取得 + 過去Discussion取得（並列）
  fetch-data:
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.fetch.outputs.has_data }}
      has_github: ${{ steps.fetch.outputs.has_github }}
      has_aws: ${{ steps.fetch.outputs.has_aws }}
      has_claudeCode: ${{ steps.fetch.outputs.has_claudeCode }}
      has_linear: ${{ steps.fetch.outputs.has_linear }}
      end_date: ${{ steps.target-date.outputs.end_date }}
      start_date: ${{ steps.target-date.outputs.start_date }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Login GitHub App
        id: login-gh-app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.KIBA_CLAUDE_CODE_GH_APP_ID }}
          private-key: ${{ secrets.KIBA_CLAUDE_CODE_GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Determine target date
        id: target-date
        run: |
          if [ -n "${{ inputs.end_date }}" ]; then
            END_DATE="${{ inputs.end_date }}"
          else
            END_DATE=$(date -u +%Y-%m-%d)
          fi
          # 7日前を計算
          START_DATE=$(date -u -d "${END_DATE} - 7 days" +%Y-%m-%d)
          echo "end_date=${END_DATE}" >> $GITHUB_OUTPUT
          echo "start_date=${START_DATE}" >> $GITHUB_OUTPUT
          echo "Target period: ${START_DATE} ~ ${END_DATE}"

      - name: Fetch changelogs (7 days)
        id: fetch
        env:
          GITHUB_TOKEN: ${{ steps.login-gh-app.outputs.token }}
          MUTE_WORDS_ISSUE_NUMBER: "1"
        run: |
          deno task fetch --days=7 --weekly --date=${{ steps.target-date.outputs.end_date }}

          # ファイル存在確認
          if [ -f "data/changelogs/weekly/${{ steps.target-date.outputs.end_date }}.json" ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "Data file created"
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
            echo "No data file created (no updates found)"
          fi
          # 注: has_github, has_aws, has_claudeCode, has_linear は
          # fetch-changelogs.ts から直接 GITHUB_OUTPUT に書き込まれる

      - name: Fetch all past discussions (parallel)
        if: steps.fetch.outputs.has_data == 'true'
        env:
          GITHUB_TOKEN: ${{ steps.login-gh-app.outputs.token }}
        run: |
          deno task fetch-past-discussions-all \
            --date=${{ steps.target-date.outputs.end_date }} \
            --output=data/past-discussions.json

      - name: Upload changelog data
        if: steps.fetch.outputs.has_data == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: changelog-data
          path: |
            data/changelogs/weekly/${{ steps.target-date.outputs.end_date }}.json
            data/past-discussions.json
          retention-days: 1

  # Phase 2: 要約生成（matrix戦略で並列実行）
  summarize:
    name: summarize (${{ matrix.provider }})
    needs: fetch-data
    if: needs.fetch-data.outputs.has_data == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - provider: github
            has_data: ${{ needs.fetch-data.outputs.has_github }}
            json_schema: '{"type":"object","properties":{"providerId":{"type":"string","const":"github"},"highlights":{"type":"array","items":{"type":"string"},"minItems":1,"maxItems":5},"categories":{"type":"array","items":{"type":"object","properties":{"category":{"type":"string"},"entries":{"type":"array","items":{"type":"object","properties":{"url":{"type":"string"},"title":{"type":"string"}},"required":["url","title"]}},"comment":{"type":"string"},"historicalContext":{"type":"string"}},"required":["category","entries","comment","historicalContext"]}}},"required":["providerId","highlights","categories"]}'
          - provider: aws
            has_data: ${{ needs.fetch-data.outputs.has_aws }}
            json_schema: '{"type":"object","properties":{"providerId":{"type":"string","const":"aws"},"highlights":{"type":"array","items":{"type":"string"},"minItems":1,"maxItems":5},"categories":{"type":"array","items":{"type":"object","properties":{"category":{"type":"string"},"entries":{"type":"array","items":{"type":"object","properties":{"url":{"type":"string"},"title":{"type":"string"}},"required":["url","title"]}},"comment":{"type":"string"},"historicalContext":{"type":"string"}},"required":["category","entries","comment","historicalContext"]}}},"required":["providerId","highlights","categories"]}'
          - provider: claudeCode
            has_data: ${{ needs.fetch-data.outputs.has_claudeCode }}
            json_schema: '{"type":"object","properties":{"providerId":{"type":"string","const":"claudeCode"},"highlights":{"type":"array","items":{"type":"string"},"minItems":1,"maxItems":5},"entries":{"type":"array","items":{"type":"object","properties":{"url":{"type":"string"},"title":{"type":"string"}},"required":["url","title"]}},"overallComment":{"type":"string"},"historicalContext":{"type":"string"}},"required":["providerId","highlights","entries","overallComment","historicalContext"]}'
          - provider: linear
            has_data: ${{ needs.fetch-data.outputs.has_linear }}
            json_schema: '{"type":"object","properties":{"providerId":{"type":"string","const":"linear"},"highlights":{"type":"array","items":{"type":"string"},"minItems":1,"maxItems":5},"entries":{"type":"array","items":{"type":"object","properties":{"url":{"type":"string"},"title":{"type":"string"}},"required":["url","title"]}},"overallComment":{"type":"string"},"historicalContext":{"type":"string"}},"required":["providerId","highlights","entries","overallComment","historicalContext"]}'
      fail-fast: false

    steps:
      - name: Check if provider has data
        id: check
        run: |
          if [ "${{ matrix.has_data }}" == "true" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping ${{ matrix.provider }}: no data"
          fi

      - name: Checkout repository
        if: steps.check.outputs.should_run == 'true'
        uses: actions/checkout@v4

      - name: Download changelog data
        if: steps.check.outputs.should_run == 'true'
        uses: actions/download-artifact@v4
        with:
          name: changelog-data
          path: data/

      - name: Login GitHub App
        if: steps.check.outputs.should_run == 'true'
        id: login-gh-app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.KIBA_CLAUDE_CODE_GH_APP_ID }}
          private-key: ${{ secrets.KIBA_CLAUDE_CODE_GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Generate summaries with Claude Code
        if: steps.check.outputs.should_run == 'true'
        id: summarize
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ steps.login-gh-app.outputs.token }}
        with:
          github_token: ${{ steps.login-gh-app.outputs.token }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: >-
            --json-schema '${{ matrix.json_schema }}'
          prompt: |
            data/changelogs/weekly/${{ needs.fetch-data.outputs.end_date }}.json の ${{ matrix.provider }} 部分と data/past-discussions.json の過去Discussion情報を読み込み、${{ matrix.provider }}用の週次レポートを生成してください。

            ## タスク
            ${{ matrix.provider }}の週次分析を行い、プロバイダー単位の要約を生成します。

            ## ルール
            - `muted: true` のエントリはスキップしてください
            - 過去のDiscussionを参照し、比較コメントを含めてください
            - すべて日本語で記述してください

            ## 出力構造

            ### 1. highlights (1-5件の箇条書き文)
            今週の重要な変更点を箇条書きで記述:
            - 各項目は1~5文で簡潔にまとめる
            - 技術者に影響のある更新のポイントを含める

            ### 2. 詳細データ
            - GitHub/AWS: `categories` でカテゴリ別にグループ化（labels.changelog-label または labels.products）
            - Claude Code/Linear: `entries` でリスト形式

            ### 3. コメント
            - GitHub/AWS: 各カテゴリに `comment`（2-5文）と `historicalContext`（1-2文）
            - Claude Code/Linear: `overallComment`（2-5文）と `historicalContext`（1-2文）

      - name: Save summary to file
        if: steps.check.outputs.should_run == 'true'
        run: |
          mkdir -p /tmp/summaries
          cat <<'EOF' > /tmp/summaries/${{ matrix.provider }}.json
          ${{ steps.summarize.outputs.structured_output }}
          EOF

          # 内容確認
          echo "Summary for ${{ matrix.provider }}:"
          cat /tmp/summaries/${{ matrix.provider }}.json

      - name: Upload summary artifact
        if: steps.check.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: summary-${{ matrix.provider }}
          path: /tmp/summaries/${{ matrix.provider }}.json
          retention-days: 1

  # Phase 3: Discussion投稿（並列実行）
  post-discussions:
    needs: [fetch-data, summarize]
    if: needs.fetch-data.outputs.has_data == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Login GitHub App
        id: login-gh-app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.KIBA_CLAUDE_CODE_GH_APP_ID }}
          private-key: ${{ secrets.KIBA_CLAUDE_CODE_GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Download changelog data
        uses: actions/download-artifact@v4
        with:
          name: changelog-data
          path: data/

      # 各要約ファイルをダウンロード（存在する場合のみ）
      - name: Download GitHub summary
        if: needs.fetch-data.outputs.has_github == 'true'
        uses: actions/download-artifact@v4
        with:
          name: summary-github
          path: /tmp/summaries/
        continue-on-error: true

      - name: Download AWS summary
        if: needs.fetch-data.outputs.has_aws == 'true'
        uses: actions/download-artifact@v4
        with:
          name: summary-aws
          path: /tmp/summaries/
        continue-on-error: true

      - name: Download Claude Code summary
        if: needs.fetch-data.outputs.has_claudeCode == 'true'
        uses: actions/download-artifact@v4
        with:
          name: summary-claudeCode
          path: /tmp/summaries/
        continue-on-error: true

      - name: Download Linear summary
        if: needs.fetch-data.outputs.has_linear == 'true'
        uses: actions/download-artifact@v4
        with:
          name: summary-linear
          path: /tmp/summaries/
        continue-on-error: true

      - name: Merge summaries and post discussions
        env:
          GITHUB_TOKEN: ${{ steps.login-gh-app.outputs.token }}
        run: |
          # 要約ファイルを統合
          echo "Merging summaries..."
          mkdir -p /tmp/summaries

          # 有効な要約ファイルを統合
          echo "{" > /tmp/all-summaries.json
          FIRST=true

          # NOTE: このリストは scripts/domain/weekly/types.ts の WEEKLY_PROVIDER_IDS と同期が必要
          for provider in github aws claudeCode linear; do
            FILE="/tmp/summaries/${provider}.json"
            if [ -f "$FILE" ]; then
              # jqで有効なJSONかつnullでないことを確認
              if jq -e '. != null' "$FILE" > /dev/null 2>&1; then
                if [ "$FIRST" = true ]; then
                  FIRST=false
                else
                  echo "," >> /tmp/all-summaries.json
                fi
                echo "\"$provider\": $(cat $FILE)" >> /tmp/all-summaries.json
                echo "Added $provider summary"
              fi
            fi
          done

          echo "}" >> /tmp/all-summaries.json

          echo "Merged summaries:"
          cat /tmp/all-summaries.json

          # Discussion投稿
          deno task post-weekly-all \
            --date=${{ needs.fetch-data.outputs.end_date }} \
            --changelog-file=data/changelogs/weekly/${{ needs.fetch-data.outputs.end_date }}.json \
            --summaries-file=/tmp/all-summaries.json
