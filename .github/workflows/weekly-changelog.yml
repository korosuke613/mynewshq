name: Weekly Changelog

on:
  # 毎週水曜日 01:00 UTC (10:00 JST)
  # gh-cron-trigger: "0 10 * * 3"
  workflow_dispatch:
    inputs:
      end_date:
        description: "終了日 (YYYY-MM-DD形式、空欄で今日)"
        required: false
        type: string
      use_manual_category:
        description: "manual triggerカテゴリに投稿する（手動実行時のみ選択）"
        required: false
        type: boolean
        default: false
      run_github:
        description: "GitHub Changelogを実行"
        required: false
        type: boolean
        default: true
      run_aws:
        description: "AWS What's Newを実行"
        required: false
        type: boolean
        default: true
      run_claudeCode:
        description: "Claude Codeを実行"
        required: false
        type: boolean
        default: true
      run_linear:
        description: "Linear Changelogを実行"
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  id-token: write

jobs:
  # Phase 1: データ取得 + 過去Discussion取得（並列）
  fetch-data:
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.fetch.outputs.has_data }}
      has_github: ${{ steps.fetch.outputs.has_github }}
      has_aws: ${{ steps.fetch.outputs.has_aws }}
      has_claudeCode: ${{ steps.fetch.outputs.has_claudeCode }}
      has_linear: ${{ steps.fetch.outputs.has_linear }}
      end_date: ${{ steps.target-date.outputs.end_date }}
      start_date: ${{ steps.target-date.outputs.start_date }}
      matrix: ${{ steps.build-matrix.outputs.matrix }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Login GitHub App
        id: login-gh-app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.KIBA_CLAUDE_CODE_GH_APP_ID }}
          private-key: ${{ secrets.KIBA_CLAUDE_CODE_GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Determine target date
        id: target-date
        run: |
          if [ -n "${{ inputs.end_date }}" ]; then
            END_DATE="${{ inputs.end_date }}"
          else
            END_DATE=$(date -u +%Y-%m-%d)
          fi
          # 7日前を計算
          START_DATE=$(date -u -d "${END_DATE} - 7 days" +%Y-%m-%d)
          echo "end_date=${END_DATE}" >> $GITHUB_OUTPUT
          echo "start_date=${START_DATE}" >> $GITHUB_OUTPUT
          echo "Target period: ${START_DATE} ~ ${END_DATE}"

      - name: Fetch changelogs (7 days)
        id: fetch
        env:
          GITHUB_TOKEN: ${{ steps.login-gh-app.outputs.token }}
          MUTE_WORDS_ISSUE_NUMBER: "1"
          CATEGORY_CONFIG_ISSUE_NUMBER: "104"
        run: |
          deno task fetch --days=7 --weekly --date=${{ steps.target-date.outputs.end_date }}

          # ファイル存在確認
          if [ -f "data/changelogs/weekly/${{ steps.target-date.outputs.end_date }}.json" ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "Data file created"
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
            echo "No data file created (no updates found)"
          fi
          # 注: has_github, has_aws, has_claudeCode, has_linear は
          # fetch-changelogs.ts から直接 GITHUB_OUTPUT に書き込まれる

      - name: Fetch all past discussions (parallel)
        if: steps.fetch.outputs.has_data == 'true'
        env:
          GITHUB_TOKEN: ${{ steps.login-gh-app.outputs.token }}
        run: |
          deno task fetch-past-discussions-all \
            --date=${{ steps.target-date.outputs.end_date }} \
            --output=data/past-discussions.json

      - name: Filter muted entries for summarization
        if: steps.fetch.outputs.has_data == 'true'
        run: |
          deno task filter-muted \
            --input=data/changelogs/weekly/${{ steps.target-date.outputs.end_date }}.json \
            --output=data/changelogs/weekly/${{ steps.target-date.outputs.end_date }}-filtered.json

      - name: Build matrix for summarize job
        if: steps.fetch.outputs.has_data == 'true'
        id: build-matrix
        run: |
          MATRIX=$(deno run scripts/build-weekly-matrix.ts \
            --event=${{ github.event_name }} \
            --run-github=${{ inputs.run_github }} \
            --run-aws=${{ inputs.run_aws }} \
            --run-claudeCode=${{ inputs.run_claudeCode }} \
            --run-linear=${{ inputs.run_linear }} \
            --has-github=${{ steps.fetch.outputs.has_github }} \
            --has-aws=${{ steps.fetch.outputs.has_aws }} \
            --has-claudeCode=${{ steps.fetch.outputs.has_claudeCode }} \
            --has-linear=${{ steps.fetch.outputs.has_linear }})
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Generated matrix: $MATRIX"

      - name: Upload changelog data
        if: steps.fetch.outputs.has_data == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: changelog-data
          path: |
            data/changelogs/weekly/${{ steps.target-date.outputs.end_date }}.json
            data/changelogs/weekly/${{ steps.target-date.outputs.end_date }}-filtered.json
            data/past-discussions.json
          retention-days: 1

  # Phase 2: 要約生成（matrix戦略で並列実行）
  # matrixは fetch-data で動的に生成され、実行対象のプロバイダーのみが含まれる
  summarize:
    name: summarize (${{ matrix.provider }})
    needs: fetch-data
    if: needs.fetch-data.outputs.has_data == 'true' && needs.fetch-data.outputs.matrix != '{"include":[]}'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.fetch-data.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download changelog data
        uses: actions/download-artifact@v4
        with:
          name: changelog-data
          path: data/

      - name: Remove unfiltered JSON to prevent AI from reading it
        run: |
          # Claude Code Actionが-filtered.jsonのみを読むよう、元のJSONを削除
          rm -f data/changelogs/weekly/${{ needs.fetch-data.outputs.end_date }}.json
          echo "Removed unfiltered JSON to ensure AI reads only filtered data"

      - name: Login GitHub App
        id: login-gh-app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.KIBA_CLAUDE_CODE_GH_APP_ID }}
          private-key: ${{ secrets.KIBA_CLAUDE_CODE_GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Generate summaries with Claude Code
        id: summarize
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ steps.login-gh-app.outputs.token }}
        with:
          github_token: ${{ steps.login-gh-app.outputs.token }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: >-
            --json-schema '${{ matrix.json_schema }}'
          prompt: |
            data/changelogs/weekly/${{ needs.fetch-data.outputs.end_date }}-filtered.json の ${{ matrix.provider }} 部分と data/past-discussions.json の過去Discussion情報を読み込み、${{ matrix.provider }}用の週次レポートを生成してください。

            ## タスク
            ${{ matrix.provider }}の週次分析を行い、プロバイダー単位の要約を生成します。

            ## ルール
            - 過去のDiscussionを参照し、比較コメントを含めてください
            - すべて日本語で記述してください

            ## 出力構造

            ### 1. highlights (1-5件の箇条書き文)
            今週の重要な変更点を箇条書きで記述:
            - 各項目は1~5文で簡潔にまとめる
            - 技術者に影響のある更新のポイントを含める

            ### 2. 詳細データ
            - GitHub/AWS: `categories` でカテゴリ別にグループ化（labels.changelog-label または labels.products）
            - Claude Code/Linear: `entries` でリスト形式

            ### 3. コメント
            - GitHub/AWS: 各カテゴリに `comment`（2-5文）と `historicalContext`（1-2文）
            - Claude Code/Linear: `overallComment`（2-5文）と `historicalContext`（1-2文）

      - name: Save summary to file
        run: |
          mkdir -p /tmp/summaries
          cat <<'EOF' > /tmp/summaries/${{ matrix.provider }}.json
          ${{ steps.summarize.outputs.structured_output }}
          EOF

          # 内容確認
          echo "Summary for ${{ matrix.provider }}:"
          cat /tmp/summaries/${{ matrix.provider }}.json

      - name: Upload summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: summary-${{ matrix.provider }}
          path: /tmp/summaries/${{ matrix.provider }}.json
          retention-days: 1

  # Phase 3: Discussion投稿（並列実行）
  post-discussions:
    needs: [fetch-data, summarize]
    if: needs.fetch-data.outputs.has_data == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Login GitHub App
        id: login-gh-app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.KIBA_CLAUDE_CODE_GH_APP_ID }}
          private-key: ${{ secrets.KIBA_CLAUDE_CODE_GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Download changelog data
        uses: actions/download-artifact@v4
        with:
          name: changelog-data
          path: data/

      # 各要約ファイルをダウンロード（存在する場合のみ）
      - name: Download GitHub summary
        if: (github.event_name != 'workflow_dispatch' || inputs.run_github) && needs.fetch-data.outputs.has_github == 'true'
        uses: actions/download-artifact@v4
        with:
          name: summary-github
          path: /tmp/summaries/
        continue-on-error: true

      - name: Download AWS summary
        if: (github.event_name != 'workflow_dispatch' || inputs.run_aws) && needs.fetch-data.outputs.has_aws == 'true'
        uses: actions/download-artifact@v4
        with:
          name: summary-aws
          path: /tmp/summaries/
        continue-on-error: true

      - name: Download Claude Code summary
        if: (github.event_name != 'workflow_dispatch' || inputs.run_claudeCode) && needs.fetch-data.outputs.has_claudeCode == 'true'
        uses: actions/download-artifact@v4
        with:
          name: summary-claudeCode
          path: /tmp/summaries/
        continue-on-error: true

      - name: Download Linear summary
        if: (github.event_name != 'workflow_dispatch' || inputs.run_linear) && needs.fetch-data.outputs.has_linear == 'true'
        uses: actions/download-artifact@v4
        with:
          name: summary-linear
          path: /tmp/summaries/
        continue-on-error: true

      - name: Merge summaries and post discussions
        env:
          GITHUB_TOKEN: ${{ steps.login-gh-app.outputs.token }}
          CATEGORY_CONFIG_ISSUE_NUMBER: "104"
          WORKFLOW_TRIGGER: ${{ inputs.use_manual_category && 'workflow_dispatch' || 'schedule' }}
        run: |
          # 要約ファイルを統合
          echo "Merging summaries..."
          mkdir -p /tmp/summaries

          # 有効な要約ファイルを統合
          echo "{" > /tmp/all-summaries.json
          FIRST=true

          # NOTE: このリストは scripts/domain/weekly/types.ts の WEEKLY_PROVIDER_IDS と同期が必要
          for provider in github aws claudeCode linear; do
            FILE="/tmp/summaries/${provider}.json"
            if [ -f "$FILE" ]; then
              # jqで有効なJSONかつnullでないことを確認
              if jq -e '. != null' "$FILE" > /dev/null 2>&1; then
                if [ "$FIRST" = true ]; then
                  FIRST=false
                else
                  echo "," >> /tmp/all-summaries.json
                fi
                echo "\"$provider\": $(cat $FILE)" >> /tmp/all-summaries.json
                echo "Added $provider summary"
              fi
            fi
          done

          echo "}" >> /tmp/all-summaries.json

          echo "Merged summaries:"
          cat /tmp/all-summaries.json

          # autoCloseフラグを設定（manual triggerカテゴリ使用時のみ）
          AUTO_CLOSE_FLAG=""
          if [ "${{ inputs.use_manual_category }}" == "true" ]; then
            AUTO_CLOSE_FLAG="--auto-close"
          fi

          # Discussion投稿（カテゴリはスクリプト内で環境変数から取得）
          deno task post-weekly-all \
            --date=${{ needs.fetch-data.outputs.end_date }} \
            --changelog-file=data/changelogs/weekly/${{ needs.fetch-data.outputs.end_date }}.json \
            --summaries-file=/tmp/all-summaries.json \
            $AUTO_CLOSE_FLAG
