name: Daily Changelog

on:
  schedule:
    # 毎日 9:00 JST (UTC 0:00)
    - cron: "0 0 * * *"
  workflow_dispatch: # 手動実行も可能

permissions:
  contents: read
  discussions: write
  id-token: write

jobs:
  changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Fetch changelogs
        run: deno task fetch

      - name: Login GitHub App
        id: login-gh-app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.KIBA_CLAUDE_CODE_GH_APP_ID }}
          private-key: ${{ secrets.KIBA_CLAUDE_CODE_GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Summarize and post with Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ steps.login-gh-app.outputs.token }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --allowedTools "Write,Bash(cat *),Bash(deno task post *)"
          prompt: |
            data/changelogs/ ディレクトリにある最新のJSONファイルを読み込んで、
            日本語で要約を生成してください。

            要約のルール：
            1. GitHub Changelog、AWS What's New、Claude Codeの3つのセクションに分ける
            2. 各エントリについて、タイトルとURLをリンク形式で表示
            3. 内容を2-3文で簡潔に日本語で要約
            4. 技術者向けにわかりやすく、重要なポイントを強調
            5. 更新がないセクションは省略する

            要約が完成したら、以下のコマンドを実行してDiscussionに投稿してください：
            ```bash
            deno task post korosuke613 mynewshq General "$(cat summary.md)"
            ```

            summary.mdには生成した要約を保存してください。
