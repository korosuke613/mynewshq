name: Daily Changelog

on:
  schedule:
    # 毎日 9:00 JST (UTC 0:00)
    - cron: "0 0 * * *"
  workflow_dispatch: # 手動実行も可能

permissions:
  contents: read
  discussions: write
  pull-requests: write

jobs:
  changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Fetch changelogs
        run: deno task fetch

      - name: Summarize and post with Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            data/changelogs/ ディレクトリにある最新のJSONファイルを読み込んで、
            日本語で要約を生成してください。

            要約のルール：
            1. GitHub Changelog、AWS What's New、Claude Codeの3つのセクションに分ける
            2. 各エントリについて、タイトルとURLをリンク形式で表示
            3. 内容を2-3文で簡潔に日本語で要約
            4. 技術者向けにわかりやすく、重要なポイントを強調
            5. 更新がないセクションは省略する

            要約が完成したら、以下のコマンドを実行してDiscussionに投稿してください：
            ```bash
            deno task post korosuke613 mynewshq General "$(cat summary.md)"
            ```

            summary.mdには生成した要約を保存してください。
