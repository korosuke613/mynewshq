name: Fetch Changelogs

on:
  schedule:
    # ÊØéÊó• 9:00 JST (UTC 0:00)
    - cron: "0 0 * * *"
  workflow_dispatch: # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

permissions:
  contents: read
  issues: write

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Fetch and post changelogs
        uses: actions/github-script@v7
        with:
          script: |
            const { exec } = require('child_process');
            const { promisify } = require('util');
            const execAsync = promisify(exec);

            // Fetch changelogs
            console.log('Fetching changelogs...');
            const { stdout, stderr } = await execAsync('deno task fetch');
            console.log(stdout);
            if (stderr) console.error(stderr);

            // Read the generated JSON file
            const fs = require('fs');
            const files = fs.readdirSync('data/changelogs').filter(f => f.endsWith('.json'));

            if (files.length === 0) {
              console.log('No changelog files found');
              return;
            }

            // Get the latest file
            const sortedFiles = files.sort().reverse();
            const latestFile = `data/changelogs/${sortedFiles[0]}`;
            const changelogData = fs.readFileSync(latestFile, 'utf8');

            // Post to Issue
            const issueNumber = 1;
            const today = new Date().toISOString().split('T')[0];

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `üì∞ ${today}„ÅÆChangelog„ÇíË¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n<details>\n<summary>Changelog Data</summary>\n\n\`\`\`json\n${changelogData}\n\`\`\`\n\n</details>`
            });

            console.log(`Posted changelog data to Issue #${issueNumber}`);

            // Clean up - remove the temporary file
            fs.unlinkSync(latestFile);
            console.log(`Cleaned up temporary file: ${latestFile}`);
