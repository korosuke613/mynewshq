name: Discussion Claude Mention Trigger

on:
  discussion_comment:
    types: [created]

permissions:
  actions: write

jobs:
  trigger-claude:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '@claude') && github.event.comment.user.login == 'korosuke613'

    steps:
      - name: Parse mention content
        id: parse-mention
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # @claude を削除して残りを質問として取得
          question=$(echo "$COMMENT_BODY" | sed 's/@claude[[:space:]]*//')
          # 前後の空白を削除
          question=$(echo "$question" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          if [ -z "$question" ]; then
            echo "question=質問内容が空です" >> $GITHUB_OUTPUT
          else
            # 複数行対応とエスケープ処理
            question=$(echo "$question" | tr '\n' ' ')
            echo "question=$question" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Claude Code workflow
        env:
          GH_TOKEN: ${{ github.token }}
          QUESTION: ${{ steps.parse-mention.outputs.question }}
        run: |
          gh workflow run discussion-claude-answer.yml \
            --repo ${{ github.repository }} \
            --field question="$QUESTION" \
            --field discussion_number="${{ github.event.discussion.number }}" \
            --field comment_url="${{ github.event.comment.html_url }}"
