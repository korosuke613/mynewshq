# ãƒ†ã‚¹ãƒˆè¿½åŠ è¨ˆç”»

## æ¦‚è¦

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«Denoã®æ¨™æº–ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã‚’å°å…¥ã—ã€ç´”ç²‹é–¢æ•°ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹ã€‚

## å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«

### ä¿®æ­£ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

- `scripts/fetch-changelogs.ts` - `isRecent`é–¢æ•°ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¨ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
- `scripts/create-discussion.ts` - `generateDefaultBody`é–¢æ•°ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- `deno.json` - testã‚¿ã‚¹ã‚¯è¿½åŠ 
- `.github/workflows/quality-check.yml` - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ 

### æ–°è¦ä½œæˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

- `scripts/fetch-changelogs_test.ts`
- `scripts/create-discussion_test.ts`

## å®Ÿè£…æ‰‹é †

### Step 1: `fetch-changelogs.ts` ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

è¡Œ29-34ã®`isRecent`é–¢æ•°ã‚’ä¿®æ­£:

```typescript
// Before
function isRecent(dateString: string): boolean {
  const date = new Date(dateString);
  const now = new Date();
  const dayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
  return date >= dayAgo;
}

// After
export function isRecent(dateString: string, now: Date = new Date()): boolean {
  const date = new Date(dateString);
  const dayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
  return date >= dayAgo;
}
```

`now`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã«ã™ã‚‹ã“ã¨ã§ã€æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã«å½±éŸ¿ãªããƒ†ã‚¹ãƒˆå¯èƒ½ã«ãªã‚‹ã€‚

### Step 2: `create-discussion.ts` ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

è¡Œ175ã®`generateDefaultBody`é–¢æ•°ã«exportã‚’è¿½åŠ :

```typescript
// Before
function generateDefaultBody(data: ChangelogData): string {

// After
export function generateDefaultBody(data: ChangelogData): string {
```

### Step 3: `deno.json` ã«testã‚¿ã‚¹ã‚¯è¿½åŠ 

```json
{
  "tasks": {
    "fetch": "deno run --allow-net --allow-read --allow-write scripts/fetch-changelogs.ts",
    "post": "deno run --allow-net --allow-read --allow-env scripts/create-discussion.ts",
    "test": "deno test --allow-read"
  },
  "imports": {
    "@octokit/rest": "npm:@octokit/rest@21.0.2",
    "@octokit/graphql": "npm:@octokit/graphql@8.1.1",
    "rss-parser": "npm:rss-parser@3.13.0"
  }
}
```

### Step 4: `scripts/fetch-changelogs_test.ts` ä½œæˆ

```typescript
import { assertEquals } from "jsr:@std/assert";
import { isRecent } from "./fetch-changelogs.ts";

const NOW = new Date("2026-01-18T12:00:00Z");

Deno.test("isRecent", async (t) => {
  await t.step("24æ™‚é–“ä»¥å†…ã®æ—¥ä»˜ã¯trueã‚’è¿”ã™", () => {
    assertEquals(isRecent("2026-01-18T00:00:00Z", NOW), true);
  });

  await t.step("ã¡ã‚‡ã†ã©24æ™‚é–“å‰ã¯trueã‚’è¿”ã™ï¼ˆå¢ƒç•Œå€¤ï¼‰", () => {
    assertEquals(isRecent("2026-01-17T12:00:00Z", NOW), true);
  });

  await t.step("24æ™‚é–“ã‚ˆã‚Šå‰ã¯falseã‚’è¿”ã™", () => {
    assertEquals(isRecent("2026-01-17T11:59:59Z", NOW), false);
  });

  await t.step("1é€±é–“å‰ã¯falseã‚’è¿”ã™", () => {
    assertEquals(isRecent("2026-01-11T12:00:00Z", NOW), false);
  });

  await t.step("æœªæ¥ã®æ—¥ä»˜ã¯trueã‚’è¿”ã™", () => {
    assertEquals(isRecent("2026-01-19T00:00:00Z", NOW), true);
  });

  await t.step("RFC 2822å½¢å¼ã‚’å‡¦ç†ã§ãã‚‹", () => {
    assertEquals(isRecent("Sat, 18 Jan 2026 00:00:00 GMT", NOW), true);
  });
});
```

### Step 5: `scripts/create-discussion_test.ts` ä½œæˆ

```typescript
import { assertEquals, assertStringIncludes } from "jsr:@std/assert";
import { generateDefaultBody } from "./create-discussion.ts";

const mockData = {
  date: "2026-01-18",
  github: [{
    title: "Feature A",
    url: "https://example.com/a",
    content: "",
    pubDate: "2026-01-18T10:00:00Z",
  }],
  aws: [{
    title: "Update B",
    url: "https://example.com/b",
    content: "",
    pubDate: "2026-01-18T11:00:00Z",
  }],
  claudeCode: [{
    version: "v2.1.12",
    url: "https://example.com/c",
    body: "",
    publishedAt: "2026-01-17T16:00:00Z",
  }],
};

Deno.test("generateDefaultBody", async (t) => {
  await t.step("å…¨ã‚«ãƒ†ã‚´ãƒªã®ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹", () => {
    const body = generateDefaultBody(mockData);
    assertStringIncludes(body, "# ğŸ“° Tech Changelog - 2026-01-18");
    assertStringIncludes(body, "## GitHub Changelog");
    assertStringIncludes(body, "## AWS What's New");
    assertStringIncludes(body, "## Claude Code");
  });

  await t.step("ç©ºã®ã‚«ãƒ†ã‚´ãƒªã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«å«ã‚ãªã„", () => {
    const body = generateDefaultBody({ ...mockData, github: [] });
    assertEquals(body.includes("## GitHub Changelog"), false);
    assertStringIncludes(body, "## AWS What's New");
  });

  await t.step("Markdownãƒªãƒ³ã‚¯å½¢å¼ã§å‡ºåŠ›ã™ã‚‹", () => {
    const body = generateDefaultBody(mockData);
    assertStringIncludes(body, "[Feature A](https://example.com/a)");
  });
});
```

### Step 6: `.github/workflows/quality-check.yml` æ›´æ–°

```yaml
- name: Format check
  run: deno fmt --check

- name: Test
  run: deno task test
```

## æ¤œè¨¼æ–¹æ³•

1. `deno task test` ã§ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
2. `deno lint` ã¨ `deno check scripts/*.ts` ãŒå¼•ãç¶šããƒ‘ã‚¹ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
3. æ—¢å­˜æ©Ÿèƒ½ `deno task fetch`
   ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆisRecentã®ã‚·ã‚°ãƒãƒãƒ£å¤‰æ›´ã«ã‚ˆã‚‹å½±éŸ¿ãªã—ï¼‰
